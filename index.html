<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="ie=edge" http-equiv="x-ua-compatible">
    <meta name="description" content="专业记账系统">

    <title>专业记账系统</title>

    <link rel="stylesheet" type="text/css" href="https://meyerweb.com/eric/tools/css/reset/reset.css">

    <style>
        body {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        #cmdLine {
            border-bottom: gray 1.5px solid;
            font-size: 16px;
        }
        #editor {
            flex-grow: 1;
            font-size: 16px;
        }
    </style>

  </head>
  <body>

    <div id="cmdLine"></div>
    <div id="editor"></div>

    <script src="https://cdn.jsdelivr.net/gh/ajaxorg/ace-builds/src-min/ace.js"></script>
    <script>
        const singleLineEditor = (el) => {
            const renderer = new ace.VirtualRenderer(el);
            el.style.overflow = 'hidden';

            renderer.screenToTextCoordinates = function(x, y) {
                const pos = this.pixelToScreenCoordinates(x, y);
                return this.session.screenToDocumentPosition(
                    Math.min(this.session.getScreenLength() - 1, Math.max(pos.row, 0)),
                    Math.max(pos.column, 0)
                );
            };

            renderer.$maxLines = 1;

            renderer.setStyle('ace_one-line');
            const editor = new ace.Editor(renderer);
            editor.session.setUndoManager(new ace.UndoManager());

            editor.setShowPrintMargin(false);
            editor.renderer.setShowGutter(false);
            editor.renderer.setHighlightGutterLine(false);
            editor.$mouseHandler.$focusWaitTimout = 0;

            return editor;
        };

        const editor = ace.edit('editor');
        const cmdLine = singleLineEditor(document.getElementById('cmdLine'));
        cmdLine.editor = editor;
        editor.cmdLine = cmdLine;

        editor.renderer.setShowGutter(false);
        editor.commands.addCommand({
            name: 'upsert',
            bindKey: 'Alt-Enter',
            exec: () => console.log('upsert'), // TODO
            readOnly: false,
        }, {
            name: 'remove',
            bindKey: 'Alt-Delete',
            exec: () => console.log('remove'), // TODO
            readOnly: false,
        });
        editor.commands.bindKeys({
            'Esc': (e) => { e.cmdLine.focus(); },
        });
        editor.showCommandLine = (val) => {
            cmdLine.focus();
            if (typeof val == 'string')
                editor.cmdLine.setValue(val, 1);
        };

        cmdLine.commands.bindKeys({
            'Tab': (e) => { e.editor.focus(); },
            'Return': (e) => {
                const command = e.getValue();
                console.log(command); // TODO
                e.setValue('');
                e.editor.focus();
            },
        });
        cmdLine.commands.removeCommands(['find', 'gotoline', 'findall', 'replace', 'replaceall']);
        cmdLine.focus();
    </script>

  </body>
</html>
